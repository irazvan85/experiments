<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Operator Label Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js" onload="window.qrCodeLoaded = true" onerror="loadFallbackQR()"></script>
    <script>
        // Global variable to track QR library loading
        window.qrCodeLoaded = false;
        
        // Fallback QR code library loader
        function loadFallbackQR() {
            console.log('Loading fallback QR library...');
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js';
            script.onload = function() {
                window.qrCodeLoaded = true;
                console.log('Fallback QR library loaded');
            };
            script.onerror = function() {
                console.error('Both QR libraries failed to load');
                window.qrCodeLoaded = false;
            };
            document.head.appendChild(script);
        }
        
        // Wait for QR library to load
        function waitForQRCode(callback, maxAttempts = 50) {
            let attempts = 0;
            const checkInterval = setInterval(() => {
                attempts++;
                if (typeof QRCode !== 'undefined' || window.qrCodeLoaded) {
                    clearInterval(checkInterval);
                    callback(true);
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    callback(false);
                }
            }, 100);
        }
        
        // Simple fallback QR code generator using different APIs based on type
        function generateSimpleQR(text, container, qrType = 'standard', size = 120) {
            let qrUrl = '';
            
            switch(qrType) {
                case 'micro':
                    qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&qzone=1&data=${encodeURIComponent(text)}`;
                    break;
                case 'datamatrix':
                    qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&format=svg&qzone=0&data=${encodeURIComponent(text)}`;
                    break;
                case 'pdf417':
                case 'aztec':
                    // Fallback to standard QR for unsupported types
                    qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}`;
                    break;
                default:
                    qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}`;
            }
            
            const img = document.createElement('img');
            img.src = qrUrl;
            img.style.border = '1px solid #ddd';
            img.style.borderRadius = '5px';
            img.alt = 'QR Code';
            img.onload = function() {
                container.innerHTML = '';
                container.appendChild(img);
                hideProgress();
            };
            img.onerror = function() {
                container.innerHTML = '<div style="color: red; font-size: 12px;">Unable to generate QR code</div>';
                hideProgress();
            };
        }

        // Progress bar functions
        function showProgress() {
            const progressContainer = document.getElementById('progressContainer');
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');
            
            progressContainer.style.display = 'block';
            progressText.style.display = 'block';
            progressBar.style.width = '0%';
            
            // Animate progress bar
            setTimeout(() => progressBar.style.width = '30%', 100);
            setTimeout(() => progressBar.style.width = '60%', 300);
            setTimeout(() => progressBar.style.width = '90%', 500);
        }

        function hideProgress() {
            const progressContainer = document.getElementById('progressContainer');
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');
            
            progressBar.style.width = '100%';
            setTimeout(() => {
                progressContainer.style.display = 'none';
                progressText.style.display = 'none';
                progressBar.style.width = '0%';
            }, 300);
        }

        function showQRLoading(container) {
            container.innerHTML = `
                <div class="qr-loading">
                    <div class="spinner"></div>
                    <div>Generating QR Code...</div>
                </div>
            `;
        }
    </script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #2c5364 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #181f2a;
            border-radius: 18px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.18);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #232526 0%, #414345 100%);
            color: #eaf6fb;
            padding: 32px 30px 18px 30px;
            text-align: center;
            border-bottom: 2px solid #1e293b;
        }

        .header h1 {
            font-size: 2.3em;
            margin-bottom: 8px;
            letter-spacing: 2px;
            color: #00eaff;
            text-shadow: 0 2px 8px #0f2027;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.92;
            color: #b0c4d4;
        }

        .cockpit-header {
            background: linear-gradient(90deg, #0a192f 0%, #1e293b 100%);
            color: #eaf6fb;
            padding: 32px 30px 18px 30px;
            text-align: center;
            border-bottom: 2px solid #00eaff;
            position: relative;
        }
        .cockpit-bar {
            position: absolute;
            left: 0; right: 0; top: 0;
            height: 8px;
            background: linear-gradient(90deg, #00eaff 0%, #232526 100%);
            border-radius: 0 0 8px 8px;
        }
        .cockpit-header h1 {
            font-size: 2.3em;
            margin-bottom: 8px;
            letter-spacing: 2px;
            color: #00eaff;
            text-shadow: 0 2px 8px #0f2027;
        }
        .cockpit-desc {
            font-size: 1.1em;
            opacity: 0.92;
            color: #b0c4d4;
        }
        .cockpit-highlight {
            color: #00eaff;
            font-weight: bold;
        }
        .cockpit-icon {
            font-size: 1.2em;
            margin-right: 8px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .form-section {
            background: #232b38;
            padding: 28px 25px 25px 25px;
            border-radius: 12px;
            border: 1px solid #1e293b;
            color: #eaf6fb;
        }

        .form-section h2 {
            color: #00eaff;
            margin-bottom: 18px;
            font-size: 1.3em;
            border-bottom: 2px solid #00eaff;
            padding-bottom: 8px;
            letter-spacing: 1px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #00eaff;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #1e293b;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background-color: #1a2233;
            color: #eaf6fb;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00eaff;
            box-shadow: 0 0 0 3px rgba(0, 234, 255, 0.13);
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .button {
            background: linear-gradient(90deg, #00eaff 0%, #232526 100%);
            color: #181f2a;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            box-shadow: 0 2px 8px #0f2027;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px #00eaff44;
            background: linear-gradient(90deg, #00eaff 0%, #1e293b 100%);
        }

        .button:active {
            transform: translateY(0);
        }

        .download-button {
            background: linear-gradient(90deg, #00eaff 0%, #ff6b6b 100%);
            color: #181f2a;
            margin-top: 10px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group .button {
            flex: 1;
            margin-top: 0;
        }

        .preview-section {
            background: #232b38;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #1e293b;
            text-align: center;
            color: #eaf6fb;
        }

        .label-preview {
            background: #181f2a;
            border: 2px solid #00eaff;
            border-radius: 12px;
            padding: 2px;
            margin: 20px auto;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px #00eaff22;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .label-preview.shape-rectangle {
            border-radius: 5px;
        }

        .label-preview.shape-square {
            border-radius: 5px;
            aspect-ratio: 1;
        }

        .label-preview.shape-circle {
            border-radius: 50%;
            aspect-ratio: 1;
        }

        .label-preview.shape-rounded {
            border-radius: 15px;
        }

        .size-info {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        .label-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 1px;
            box-sizing: border-box;
            overflow: hidden;
        }

        .label-content.single-column {
            flex-direction: column;
            text-align: center;
            justify-content: center;
        }

        .qr-section {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 35%; /* Increased to better utilize space */
            overflow: hidden; /* Prevent overflow */
            height: 100%; /* Use full height */
            box-sizing: border-box;
        }

        .text-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
        }

        .label-title {
            font-weight: bold;
            color: #00eaff;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            line-height: 0.9;
            text-shadow: 0 2px 8px #0f2027;
        }

        .label-info {
            margin: 1px 0;
            color: #b0c4d4;
            line-height: 1.1;
            word-wrap: break-word;
        }

        .label-info strong {
            color: #00eaff;
        }

        #qrcode {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #232b38;
            border-radius: 8px;
            max-width: 100%; /* Ensure QR code container doesn't exceed parent */
            max-height: 100%; /* Ensure QR code container doesn't exceed parent */
        }

        #qrcode canvas,
        #qrcode img {
            max-width: 100% !important;
            max-height: 100% !important;
            width: auto !important;
            height: auto !important;
            object-fit: contain;
        }

        .custom-fields {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid #e9ecef;
        }

        .size-info {
            font-size: 6px;
            color: #999;
            margin-top: 1px;
            text-align: center;
            line-height: 1;
        }

        .custom-field {
            display: flex;
            margin-bottom: 10px;
            gap: 10px;
        }

        .custom-field input {
            flex: 1;
        }

        .remove-field {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-field {
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .print-button {
            background: linear-gradient(90deg, #00eaff 0%, #27ae60 100%);
            color: #181f2a;
            margin-top: 20px;
        }

        .progress-container {
            position: relative;
            margin: 10px 0;
            background: #1e293b;
            border-radius: 8px;
            height: 6px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00eaff 0%, #27ae60 100%);
            border-radius: 8px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 12px;
            color: #00eaff;
            text-align: center;
            margin-top: 5px;
            display: none;
        }

        .qr-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #00eaff;
            font-size: 12px;
        }

        .spinner {
            border: 2px solid #1e293b;
            border-top: 2px solid #00eaff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }
            
            .label-preview, .label-preview * {
                visibility: visible;
            }
            
            .label-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100% !important;
                height: 100% !important;
                margin: 0 !important;
                padding: 20px !important;
                box-shadow: none !important;
                border: 2px solid #000 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header cockpit-header">
            <div class="cockpit-bar"></div>
            <h1><span class="cockpit-icon">🛩️</span> Drone Operator Label</h1>
            <p class="cockpit-desc">Generate a professional drone operator label with all required regulatory and contact details. <span class="cockpit-highlight">Cockpit Mode</span></p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2>Pilot & Drone Information</h2>
                <div class="form-group">
                    <label for="operatorId">Operator Registration ID *</label>
                    <input type="text" id="operatorId" placeholder="e.g., RO-DRONE-123456" required>
                </div>
                <div class="form-group">
                    <label for="pilotName">Pilot Full Name *</label>
                    <input type="text" id="pilotName" placeholder="e.g., John Doe" required>
                </div>
                <div class="form-group">
                    <label for="phoneNumber">Contact Phone *</label>
                    <input type="tel" id="phoneNumber" placeholder="e.g., +40 712 345 678" required>
                </div>
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" placeholder="e.g., john.doe@email.com">
                </div>
                <div class="form-group">
                    <label for="droneName">Drone Model</label>
                    <input type="text" id="droneName" placeholder="e.g., DJI Mavic 3" required>
                </div>
                <div class="form-group">
                    <label for="droneSerial">Drone Serial Number</label>
                    <input type="text" id="droneSerial" placeholder="e.g., SN1234567890">
                </div>
                <div class="form-group">
                    <label for="operatorAddress">Operator Address</label>
                    <input type="text" id="operatorAddress" placeholder="e.g., 123 Aviation St, Bucharest, RO">
                </div>
                <div class="form-group">
                    <label for="insurance">Insurance Policy Number</label>
                    <input type="text" id="insurance" placeholder="e.g., INS-987654321">
                </div>
                <div class="form-group">
                    <label for="uasClass">UAS Class</label>
                    <input type="text" id="uasClass" placeholder="e.g., C1, C2, C3, Open, Specific">
                </div>
                <div class="form-group">
                    <label for="operatorCountry">Country of Registration</label>
                    <input type="text" id="operatorCountry" placeholder="e.g., Romania">
                </div>

                <h2 style="margin-top: 30px;">Label Configuration</h2>
                
                <div class="form-group">
                    <label for="labelShape">Label Shape</label>
                    <select id="labelShape">
                        <option value="rectangle">Rectangle</option>
                        <option value="square">Square</option>
                        <option value="circle">Circle</option>
                        <option value="rounded">Rounded Rectangle</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="labelSize">Label Size (mm)</label>
                    <select id="labelSize">
                        <option value="25x25">25 x 25 mm (Small Square)</option>
                        <option value="30x30">30 x 30 mm (Medium Square)</option>
                        <option value="40x40">40 x 40 mm (Large Square)</option>
                        <option value="50x25" selected>50 x 25 mm (Standard Rectangle)</option>
                        <option value="60x30">60 x 30 mm (Medium Rectangle)</option>
                        <option value="80x40">80 x 40 mm (Large Rectangle)</option>
                        <option value="100x50">100 x 50 mm (XL Rectangle)</option>
                        <option value="custom">Custom Size</option>
                    </select>
                </div>

                <div id="customSizeFields" style="display: none;">
                    <div class="form-group" style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label for="customWidth">Width (mm)</label>
                            <input type="number" id="customWidth" min="20" max="200" value="50">
                        </div>
                        <div style="flex: 1;">
                            <label for="customHeight">Height (mm)</label>
                            <input type="number" id="customHeight" min="15" max="200" value="25">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="qrCodeType">QR Code Type</label>
                    <select id="qrCodeType">
                        <option value="standard">Standard QR Code</option>
                        <option value="micro">Micro QR Code</option>
                        <option value="datamatrix">Data Matrix</option>
                        <option value="pdf417">PDF417</option>
                        <option value="aztec">Aztec Code</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="qrSize">QR Code Size</label>
                    <select id="qrSize">
                        <option value="80">Small (80px)</option>
                        <option value="100">Medium (100px)</option>
                        <option value="120" selected>Standard (120px)</option>
                        <option value="150">Large (150px)</option>
                        <option value="200">XL (200px)</option>
                    </select>
                </div>

                <h2 style="margin-top: 30px;">Custom QR Code Fields</h2>
                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    Add custom information to be encoded in the QR code
                </p>
                
                <div id="customFields">
                    <div class="custom-field">
                        <input type="text" placeholder="Field name (e.g., Registration)" class="field-name">
                        <input type="text" placeholder="Field value" class="field-value">
                        <button type="button" class="remove-field" onclick="removeField(this)">×</button>
                    </div>
                </div>
                
                <button type="button" class="add-field" onclick="addField()">+ Add Field</button>
                
                <button type="button" class="button" onclick="generateLabel()" style="margin-top: 30px;">
                    Generate Label
                </button>
            </div>

            <div class="preview-section">
                <h2>Label Preview</h2>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-text" id="progressText">Generating QR Code...</div>
                
                <div class="label-preview" id="labelPreview">
                    <div class="label-content">
                        <div class="label-title">Drone Label Generator</div>
                        <div class="label-info">Fill out the form to generate your drone label</div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button type="button" class="button print-button" onclick="printLabel()">
                        🖨️ Print Label
                    </button>
                    <button type="button" class="button download-button" onclick="downloadLabel()">
                        💾 Download PNG
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function addField() {
            const customFields = document.getElementById('customFields');
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'custom-field';
            fieldDiv.innerHTML = `
                <input type="text" placeholder="Field name" class="field-name">
                <input type="text" placeholder="Field value" class="field-value">
                <button type="button" class="remove-field" onclick="removeField(this)">×</button>
            `;
            customFields.appendChild(fieldDiv);
            
            // Add event listeners for the new fields
            const newInputs = fieldDiv.querySelectorAll('input');
            newInputs.forEach(input => {
                input.addEventListener('input', generateLabel);
            });
        }

        function removeField(button) {
            const customFields = document.getElementById('customFields');
            if (customFields.children.length > 1) {
                button.parentElement.remove();
            }
        }

        function generateLabel() {
            const operatorId = document.getElementById('operatorId').value;
            const pilotName = document.getElementById('pilotName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const droneName = document.getElementById('droneName').value;
            
            // Get configuration values
            const labelShape = document.getElementById('labelShape').value;
            const labelSize = document.getElementById('labelSize').value;
            const qrCodeType = document.getElementById('qrCodeType').value;
            const qrSize = parseInt(document.getElementById('qrSize').value);

            // Handle custom size
            let width, height;
            if (labelSize === 'custom') {
                width = parseInt(document.getElementById('customWidth').value) || 50;
                height = parseInt(document.getElementById('customHeight').value) || 25;
            } else {
                const [w, h] = labelSize.split('x').map(v => parseInt(v));
                width = w;
                height = h;
            }

            // Collect custom fields
            const customFields = [];
            const fieldElements = document.querySelectorAll('.custom-field');
            fieldElements.forEach(field => {
                const name = field.querySelector('.field-name').value.trim();
                const value = field.querySelector('.field-value').value.trim();
                if (name && value) {
                    customFields.push(`${name}: ${value}`);
                }
            });

            // Create QR code data
            let qrData = '';
            if (operatorId || phoneNumber) {
                qrData = `Operator ID: ${operatorId || 'Not provided'}\nPhone: ${phoneNumber || 'Not provided'}`;
                if (droneName) qrData += `\nDrone: ${droneName}`;
                if (pilotName) qrData += `\nPilot: ${pilotName}`;
                if (customFields.length > 0) {
                    qrData += '\n' + customFields.join('\n');
                }
            } else {
                qrData = 'Please fill in Operator ID and Phone Number to generate QR code';
            }

            // Apply label styling based on configuration
            const labelPreview = document.getElementById('labelPreview');
            
            // Remove existing shape classes
            labelPreview.className = labelPreview.className.replace(/shape-\w+/g, '');
            labelPreview.classList.add(`shape-${labelShape}`);
            
            // Set dimensions (convert mm to approximate pixels for preview - rough conversion 1mm ≈ 3.78px)
            const pixelWidth = Math.round(width * 3.78);
            const pixelHeight = Math.round(height * 3.78);
            
            labelPreview.style.width = `${pixelWidth}px`;
            labelPreview.style.maxWidth = `${pixelWidth}px`;
            labelPreview.style.height = `${pixelHeight}px`;
            labelPreview.style.minHeight = `${pixelHeight}px`;

            // Generate label content with side-by-side layout
            const isSmallLabel = width < 35 || height < 20; // Adjusted thresholds for better space usage
            const titleFontSize = Math.max(6, Math.min(16, width / 4)); // Improved font scaling
            const infoFontSize = Math.max(5, Math.min(12, width / 6)); // Better info font scaling
            
            let labelContent = '';
            
            if (isSmallLabel) {
                // For very small labels, use single column layout
                labelContent = `
                    <div class="label-content single-column">
                        <div id="qrcode"></div>
                `;
                
                if (operatorId) {
                    labelContent += `<div class="label-info" style="font-size: ${Math.max(4, infoFontSize - 1)}px;">${operatorId}</div>`;
                }
                
                labelContent += `<div class="size-info">${width} x ${height} mm</div></div>`;
            } else {
                // For larger labels, use side-by-side layout with optimized space
                labelContent = `
                    <div class="label-content">
                        <div class="qr-section">
                            <div id="qrcode"></div>
                        </div>
                        <div class="text-section">
                `;

                if (operatorId) {
                    labelContent += `<div class="label-info" style="font-size: ${infoFontSize}px;"><strong>ID:</strong> ${operatorId}</div>`;
                }

                if (pilotName) {
                    labelContent += `<div class="label-info" style="font-size: ${Math.max(4, infoFontSize - 1)}px;"><strong>Pilot:</strong> ${pilotName}</div>`;
                }

                if (phoneNumber) {
                    labelContent += `<div class="label-info" style="font-size: ${Math.max(4, infoFontSize - 1)}px;"><strong>Phone:</strong> ${phoneNumber}</div>`;
                }

                if (droneName) {
                    labelContent += `<div class="label-info" style="font-size: ${Math.max(4, infoFontSize - 1)}px;"><strong>Model:</strong> ${droneName}</div>`;
                }

                if (customFields.length > 0) {
                    customFields.forEach(field => {
                        labelContent += `<div class="label-info" style="font-size: ${Math.max(3, infoFontSize - 2)}px;">${field}</div>`;
                    });
                }

                if (!operatorId && !pilotName && !phoneNumber && !droneName && customFields.length === 0) {
                    labelContent += `<div class="label-info" style="font-size: ${infoFontSize}px;">Fill out the form</div>`;
                }

                labelContent += `<div class="size-info">${width} x ${height} mm</div></div></div>`;
            }

            // Update preview
            labelPreview.innerHTML = labelContent;

            // Generate QR code
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = ''; // Clear previous QR code
            
            // Show progress and loading
            showProgress();
            showQRLoading(qrContainer);
            
            // Final adjustment for QR code sizing - optimized for maximum space usage
            let adjustedQrSize;
            if (isSmallLabel) {
                // For small labels, QR takes up most of the available space
                const availableWidth = pixelWidth - 4; // minimal padding
                const availableHeight = pixelHeight - 20; // minimal space for text
                const maxDimension = Math.min(availableWidth * 0.8, availableHeight * 0.8);
                adjustedQrSize = Math.min(qrSize, maxDimension);
            } else {
                // For side-by-side layout, QR can be larger now with 35% width
                const totalPadding = 6; // minimal padding
                const gap = 2; // minimal gap
                
                // Available space for QR section (35% of label width for better space usage)
                const qrSectionMaxWidth = (pixelWidth * 0.35) - totalPadding;
                const qrSectionMaxHeight = pixelHeight - totalPadding;
                
                // QR code should be square, so use the smaller dimension
                const maxQrDimension = Math.min(qrSectionMaxWidth, qrSectionMaxHeight);
                
                // Don't exceed the user's selected QR size, but ensure it fits
                adjustedQrSize = Math.min(qrSize, maxQrDimension);
            }

            // Ensure minimum readable size and maximum space utilization
            adjustedQrSize = Math.max(10, Math.min(adjustedQrSize, pixelWidth * 0.5, pixelHeight * 0.9));

            // Wait for QR library to be available
            waitForQRCode(function(loaded) {
                if (!loaded || typeof QRCode === 'undefined') {
                    console.log('Primary QR library not available, using fallback...');
                    setTimeout(() => {
                        generateSimpleQR(qrData, qrContainer, qrCodeType, adjustedQrSize);
                        hideProgress();
                    }, 800);
                    return;
                }

                try {
                    setTimeout(() => {
                        QRCode.toCanvas(qrData, { 
                            width: adjustedQrSize, 
                            height: adjustedQrSize,
                            margin: 2,
                            color: {
                                dark: '#000000',
                                light: '#FFFFFF'
                            }
                        }, function (error, canvas) {
                            if (error) {
                                console.error('QR Code generation error:', error);
                                console.log('Canvas generation failed, using fallback...');
                                generateSimpleQR(qrData, qrContainer, qrCodeType, adjustedQrSize);
                            } else {
                                qrContainer.innerHTML = '';
                                canvas.style.border = '1px solid #ddd';
                                canvas.style.borderRadius = '5px';
                                qrContainer.appendChild(canvas);
                            }
                            hideProgress();
                        });
                    }, 800);
                } catch (e) {
                    console.error('QR Code error:', e);
                    console.log('Exception occurred, using fallback...');
                    setTimeout(() => {
                        generateSimpleQR(qrData, qrContainer, qrCodeType, adjustedQrSize);
                        hideProgress();
                    }, 800);
                }
            });
        }

        function printLabel() {
            window.print();
        }

        // Download label as PNG image
        function downloadLabel() {
            const labelPreview = document.getElementById('labelPreview');
            
            // Show progress
            showProgress();
            document.getElementById('progressText').textContent = 'Generating image...';
            
            // Use html2canvas library to convert the label to canvas
            if (typeof html2canvas === 'undefined') {
                // Load html2canvas library dynamically
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
                script.onload = function() {
                    captureAndDownload(labelPreview);
                };
                script.onerror = function() {
                    // Fallback method using dom-to-image
                    loadDomToImageFallback(labelPreview);
                };
                document.head.appendChild(script);
            } else {
                captureAndDownload(labelPreview);
            }
        }

        function captureAndDownload(element) {
            // Configure html2canvas options for better quality
            const options = {
                backgroundColor: '#181f2a',
                scale: 3, // Higher resolution
                useCORS: true,
                allowTaint: true,
                logging: false,
                width: element.offsetWidth,
                height: element.offsetHeight,
                scrollX: 0,
                scrollY: 0
            };

            html2canvas(element, options).then(function(canvas) {
                // Create download link
                const link = document.createElement('a');
                link.download = 'drone-label.png';
                link.href = canvas.toDataURL('image/png', 1.0);
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                hideProgress();
            }).catch(function(error) {
                console.error('Error capturing label:', error);
                loadDomToImageFallback(element);
            });
        }

        function loadDomToImageFallback(element) {
            // Load dom-to-image as fallback
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/dist/dom-to-image.min.js';
            script.onload = function() {
                domtoimage.toPng(element, {
                    bgcolor: '#181f2a',
                    quality: 1.0,
                    scale: 3
                }).then(function(dataUrl) {
                    const link = document.createElement('a');
                    link.download = 'drone-label.png';
                    link.href = dataUrl;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    hideProgress();
                }).catch(function(error) {
                    console.error('Fallback capture failed:', error);
                    // Manual canvas fallback
                    manualCanvasCapture(element);
                });
            };
            script.onerror = function() {
                console.error('Failed to load fallback library');
                manualCanvasCapture(element);
            };
            document.head.appendChild(script);
        }

        function manualCanvasCapture(element) {
            // Manual canvas creation as last resort
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const rect = element.getBoundingClientRect();
            
            // Set canvas size with higher resolution
            const scale = 3;
            canvas.width = rect.width * scale;
            canvas.height = rect.height * scale;
            ctx.scale(scale, scale);
            
            // Fill background
            ctx.fillStyle = '#181f2a';
            ctx.fillRect(0, 0, rect.width, rect.height);
            
            // Draw border
            ctx.strokeStyle = '#00eaff';
            ctx.lineWidth = 2;
            ctx.strokeRect(1, 1, rect.width - 2, rect.height - 2);
            
            // Add text indicating manual capture
            ctx.fillStyle = '#00eaff';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Label Preview', rect.width / 2, rect.height / 2);
            ctx.fillText('(Print for better quality)', rect.width / 2, rect.height / 2 + 20);
            
            // Download
            const link = document.createElement('a');
            link.download = 'drone-label.png';
            link.href = canvas.toDataURL('image/png', 1.0);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            hideProgress();
        }

        // Generate initial label when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for real-time updates
            const inputs = ['operatorId', 'pilotName', 'phoneNumber', 'droneName', 'email', 'droneSerial', 'operatorAddress', 'insurance', 'uasClass', 'operatorCountry'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', generateLabel);
            });
            
            // Add event listeners for configuration options
            const configElements = ['labelShape', 'labelSize', 'qrCodeType', 'qrSize', 'customWidth', 'customHeight'];
            configElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', generateLabel);
                    element.addEventListener('input', generateLabel);
                }
            });
            
            // Handle custom size toggle
            document.getElementById('labelSize').addEventListener('change', function() {
                const customFields = document.getElementById('customSizeFields');
                if (this.value === 'custom') {
                    customFields.style.display = 'block';
                } else {
                    customFields.style.display = 'none';
                }
                generateLabel();
            });
            
            // Add event listeners for existing custom fields
            const existingCustomInputs = document.querySelectorAll('.custom-field input');
            existingCustomInputs.forEach(input => {
                input.addEventListener('input', generateLabel);
            });
            
            // Generate an initial empty label
            setTimeout(generateLabel, 100);
        });
    </script>
</body>
</html>